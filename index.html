<!doctype html>
<html lang="en">
	<meta charset="utf-8">
  	<meta name="viewport" content="width=device-width" />
	<title></title>
	<head>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
		<script src="/assets/js/array.js"></script>
		<script src="/assets/js/underscore-min.js"></script>
		<script src="/assets/js/backbone-min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script src="/assets/js/mustache.js"></script>
		<script type="text/javascript">JSCLASS_PATH = '/assets/js/jsclass-min'</script>
		<script type="text/javascript" src="/assets/js/jsclass-min/loader-browser.js"></script>
		<script src="/assets/js/jquery.cookie.js"></script>
		<script src="/assets/js/fragment.js"></script>
		<link rel="stylesheet" href="/assets/zurb/css/normalize.css" />
  		<link rel="stylesheet" href="/assets/zurb/css/foundation.css" />
  		<script src="/assets/zurb/js/vendor/custom.modernizr.js"></script>

		<link rel="stylesheet" type="text/css" media="all" href="/assets/css/main.css" />
		

		<!--[if lt IE 9]>
      	<script src="/assets/js/html5.js"></script>
    	<![endif]-->
		<script type="text/javascript"> 
			$(document).ready(function() {
				JS.require('JS.Observable', function() {
					
					var utility = new Utility();
					var socket = io.connect('http://localhost:8080');
					var remoteSender = function(key, data) {
						socket.emit(key, data);
					};		
					var templateCache = { };
					var modelCache =  { trivia : { }, triviaList : { } };
					var locBroadcaster = new LocalBroadcaster();
					socket.on('message', function(data){
						console.log(data);
						locBroadcaster.notifyObservers({ messageKey : data.messageKey, data : data.data, isLocal : false });
					});
					
					
					
					var InitFragment = new JS.Class(Fragment, {
						
						initialize : function(){
							this.callSuper();
							this.set('isAuth', false);
						},
							
						setupMessageEvents : function(){
							var curr = this;
							this.bindMessageEvent('requestRegister', function(data, isLocal){
									if($.cookie('registerClient') == undefined){
									var id = utility.randomString(32);
									$.cookie('registerClient', id, { expires: 365, path: '/' });
								}
								else{
									$.cookie('registerClient', $.cookie('registerClient'), { expires: 365, path: '/' });
								}
								curr.sendRemoteMessage('registerClient', { sessionId : $.cookie('registerClient') });
							});
							
							this.bindMessageEvent('registerComplete', function(data, isLocal){
								curr.set('isAuth', true);
							});
						},
						
						setupVisual : function() {
							this.visualComplete();
						},
						
						setupComplete: function(){
							}
						
					});
					
					var initFragment = new InitFragment(locBroadcaster, remoteSender);
					initFragment.setup();
					initFragment.sendRemoteMessage('reRegister', { });
				
				
					var HomeFragment = new JS.Class(Fragment, {
						setupVisual : function() {
							var curr = this;
							var view = { 'trivias' : this.get('trivias') };
							this.bindToTemplate('/assets/templates/trivia-list.html', templateCache, function(template) {
								var content = Mustache.render(template, view);
								$('#contentView').html(content);
								curr.visualComplete();
							});
							
						},						
					
						setupMessageEvents: function(){
							var curr = this;
							this.bindMessageEvent('myTrivias', function(trivias, isLocal){
								curr.set('trivias', trivias);
								modelCache.triviaList['home'] = trivias;
								curr.setupVisual();
								
							});
							
							this.bindMessageEvent('registerComplete', function(data, isLocal){
								curr.getTrivias();
							});
							
							this.bindMessageEvent('triviaCreated', function(data, isLocal) {
								var rs = [data].concat(curr.get('trivias'));
								curr.set('trivias', rs); 
								modelCache.triviaList['home'] = rs;
								view.displayTriviaEdit(data._id);
								curr.close();
							});							
						},
						
						setupDOMEvents : function() {
							var curr = this;
							this.bindDOMEvent('.edit-trivia', 'click', function(e){
								e.preventDefault();
								var triviaId = $(this).attr('id');
								var trivia = curr.get('trivias').select(function(x){
									return x._id == triviaId;
								})[0];
								view.displayTriviaEdit(trivia);
								curr.close();
							});	
							
							this.bindDOMEvent('.delete-trivia', 'click', function(e){
								e.preventDefault();
								if(confirm("Are you sure you would like to delete this trivia?")){
									var id = $(this).attr('id');
									
									curr.deleteTrivia(id);
								}
							});	
							
							this.bindDOMEvent('#create-trivia-btn', 'click', function(e){
								e.preventDefault();
								var triviaName = $.trim($('#trivia-name').val());
								if(triviaName != ''){
									var data = { triviaName : triviaName };	
									curr.sendRemoteMessage('createTrivia', data);	
								}
								else{
									alert('Please insert a name');
								}
						
							});													
						},
						
						getTrivias : function(){
							if(modelCache.triviaList['home'] === undefined){
								this.sendRemoteMessage('getMyTrivias', {  });
							}
							else{
								this.sendLocalMessage('myTrivias', modelCache.triviaList['home']);
							}
						},
						
						deleteTrivia : function(triviaId){
							var rs = this.get('trivias').select(function(x){
								return x._id != triviaId;
							});
							this.set('trivias', rs);
							modelCache.triviaList['home'] = rs;
							this.bindTrivia();
							this.sendRemoteMessage('removeTrivia', { triviaId : triviaId });
						},
						
						bindTrivia: function(initLoad){
							var curr = this;
							var view = { 'trivias' : this.get('trivias') };
							this.bindToTemplate('/assets/templates/trivia-list.html', templateCache, function(template) {
								var content = Mustache.render(template, view);
								$('#contentView').html(content);
								if(!(initLoad === undefined) && initLoad == true) {
									curr.visualComplete();
								}
							});							
						}
					});
				
					var EditFragment = new JS.Class(Fragment, {
						setupVisual : function(){
							var curr = this;
							$('title').html(this.get('trivia').triviaName);
							$('#title').html(this.get('trivia').triviaName);
							this.bindToTemplate('/assets/templates/trivia-edit.html', templateCache, function(template){
								var content = Mustache.render(template, curr.get('trivia'));
								$('#contentView').html(content);
								curr.visualComplete();			
							});
							
						},
						
						setupMessageEvents : function(){
							
							var curr = this;
							this.bindMessageEvent('myTrivia', function(trivia, isLocal) {
								if(trivia._id == curr.get('triviaId')){
									
									curr.set('trivia', trivia);
									curr.setupVisual();
								}
							});
							
							this.bindMessageEvent('registerComplete', function(data, isLocal){
								curr.getTrivia();
							});
							
							
						},
						
						getTrivia : function(){
							if(modelCache.trivia[this.getTriviaId] === undefined){
								this.sendRemoteMessage('getMyTriviaByTriviaId', { triviaId : this.get('triviaId') });
							}
							else{
								this.sendLocalMessage('myTrivia', modelCache.trivia[this.getTriviaId]);
							}
						}
						
					});
									
					var ApplicationRouter = Backbone.Router.extend({
				  		routes: {
				  			'': 'home',
					  		'trivia/:id/edit/': 'editTrivia',
					  		'trivia/add': 'createTrivia',
				  		},
	
				  		home: function() {
				  			$('title').html('My Trivia');	
				  			$('#title').html('My Trivia');					
				  			var homeFragment = new HomeFragment(locBroadcaster, remoteSender);
				  			homeFragment.setupMessageEvents();
			  				if(initFragment.get('isAuth')) { 
			      				homeFragment.getTrivias();
			      			}
				  		},
				  		
				  		
				  		createTrivia: function() {
				  			var createFragment = new CreateFragment(locBroadcaster, remoteSender);
				  			createFragment.setup();
							$('title').html('Create Trivia');						
				  		},
	
				  		editTrivia: function(triviaId) {
				  			var editFragment = new EditFragment(locBroadcaster, remoteSender);
				  			editFragment.set('triviaId', triviaId);
				  			editFragment.setupMessageEvents();
				  			if(initFragment.get('isAuth')) { 
			      				editFragment.getTrivia();
			      			}
			      		},
	
				  		updateTrivia: function(triviaId) {
				  			
				  		}
	
					});	
					
					var ApplicationView = Backbone.View.extend({
					
					  initialize: function(){
						  this.router = new ApplicationRouter();
						  Backbone.history.start({pushState: true});
					  },
					
					  displayHome: function(){
						  this.router.navigate("home", true);
					  },
					  
					  displayTriviaEdit: function(triviaOrTriviaId){
					  	var id;
					  	if(typeof(triviaOrTriviaId) != 'string'){
					  		modelCache.trivia[this._id] = triviaOrTriviaId;
					  		id = triviaOrTriviaId._id;
					  	}
					  	else{
					  		id = triviaOrTriviaId
					  	}
					  	this.router.navigate("trivia/" + id + "/edit/", true);
					  }			  
					
					});
					
					var view = new ApplicationView();

				});
			});
		</script>
	</head>
	<body>
		<div id="contentView"></div>	
	</body>

</html>
