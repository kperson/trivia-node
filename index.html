<!doctype html>
<html lang="en">
	<meta charset="utf-8">
	<title></title>
	<head>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
		<script src="/assets/js/underscore-min.js"></script>
		<script src="/assets/js/backbone-min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script src="/assets/js/mustache.js"></script>
		<script type="text/javascript">JSCLASS_PATH = '/assets/js/jsclass-min'</script>
		<script type="text/javascript" src="/assets/js/jsclass-min/loader-browser.js"></script>
		<script src="/assets/js/jquery.cookie.js"></script>
		<script src="/assets/js/fragment.js"></script>
		<script type="text/javascript"> 
			$(document).ready(function() {
				JS.require('JS.Observable', function() {
					
					var utility = new Utility();
					var socket = io.connect('http://localhost:8080');
					var remoteSender = function(key, data) {
						socket.emit(key, data);
					};		
					var locBroadcaster = new LocalBroadcaster();
					socket.on('message', function(data){
						console.log(data);
						locBroadcaster.notifyObservers({ messageKey : data.messageKey, data : data.data, isLocal : false });
					});
					
					
					
					var InitFragment = new JS.Class(Fragment, {
						
						initialize : function(){
							this.callSuper();
							this.set('isAuth', false);
						},
							
						setupMessageEvents : function(){
							var curr = this;
							this.bindMessageEvent('requestRegister', function(data, isLocal){
									if($.cookie('registerClient') == undefined){
									var id = utility.randomString(32);
									$.cookie('registerClient', id, { expires: 365, path: '/' });
								}
								else{
									$.cookie('registerClient', $.cookie('registerClient'), { expires: 365, path: '/' });
								}
								curr.sendRemoteMessage('registerClient', { sessionId : $.cookie('registerClient') });
							});
							
							this.bindMessageEvent('registerComplete', function(data, isLocal){
								curr.set('isAuth', true);
							});
						},
						
						setupVisual : function() {
							this.visualComplete();
						},
						
						setupComplete: function(){
							}
						
					});
					
					var initFragment = new InitFragment(locBroadcaster, remoteSender);
					initFragment.setup();
					initFragment.sendRemoteMessage('reRegister', { });
					
					var EditFragment = new JS.Class(Fragment, {
						setupVisual : function(){
							$('title').html(this.get('trivia').triviaName);
							this.visualComplete();
						},
						
						setupMessageEvents : function(){
							
							var curr = this;
							this.bindMessageEvent('myTrivia', function(trivia, isLocal) {
								curr.set('trivia', trivia);
								
								curr.setupVisual();
							});
							
							this.bindMessageEvent('registerComplete', function(data, isLocal){
								curr.getTrivia();
							});
						},
						
						getTrivia : function(){
							this.sendRemoteMessage('getMyTriviaByTriviaId', { triviaId : this.get('triviaId') });
						}
						
					});
									
					var CreateFragment = new JS.Class(Fragment, {
						
						setupVisual : function(){
							var curr = this;
							$.get('/assets/templates/trivia.html',function(resp) {
								var content = Mustache.render(resp,{'action' : 'add'});
								$('#contentView').html(content);
								curr.visualComplete();
							});
						},
						
						setupMessageEvents : function(){
							this.bindMessageEvent('triviaCreated', function(data, isLocal) {
								view.displayTriviaEdit(data.triviaId);
							});
						},
						
						setupDOMEvents : function() {
							var curr = this;
							this.bindDOMEvent('#trivia-game', 'submit', function(e){
								e.preventDefault();
								var form = {};
								form.triviaName = $('input[name="triviaName"]',this).val();	
								curr.sendRemoteMessage('createTrivia', form);
							});							
						},
						
						setupComplete: function() {
						}
						
					});
	

					var ApplicationRouter = Backbone.Router.extend({
				  		routes: {
				  			'': 'home',
					  		'trivia/:id/edit/': 'editTrivia',
					  		'trivia/add': 'createTrivia',
				  		},
	
				  		home: function() {
				  		},
				  		
				  		
				  		createTrivia: function() {
				  			var createFragment = new CreateFragment(locBroadcaster, remoteSender);
				  			this.setup();
							$('title').html('Create Trivia');

				  		},
	
				  		editTrivia: function(triviaId) {
				  			var editFragment = new EditFragment(locBroadcaster, remoteSender);
				  			editFragment.set('triviaId', triviaId);
				  			editFragment.setupMessageEvents();
				  			if(initFragment.get('isAuth')) { 
			      				editFragment.getTrivia();
			      			}
			      		},
	
				  		updateTrivia: function(triviaId) {
				  		}
	
					});	
					
					var ApplicationView = Backbone.View.extend({
					
					  initialize: function(){
						  this.router = new ApplicationRouter();
						  Backbone.history.start({pushState: true});
					  },
					
					  displayHome: function(){
						  this.router.navigate("home", true);
					  },
					  
					  displayTriviaEdit: function(id){
						  this.router.navigate("trivia/" + id + "/edit/", true);
					  }			  
					
					});
					
					var view = new ApplicationView();
				


				});
			});
		</script>
	</head>
	<body>
		<div id="contentView">	
		</div>	
	</body>
</html>
